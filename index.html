<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link href="index.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<script>
    //ToDo. 스크립트 별도 파일에 저장, 마우스 우클릭 이벤트 방지, 변수명 통일
    $(document).ready(function () {
        $cnt = 12
        $cntMine = 35;
        for($i = 0; $i < $cnt; $i++){
            $('#board tbody.board_row').append('<tr class=' + 'row_' + ($i)  +'></tr>');
            for($j = 0; $j < $cnt; $j++){
                $('#board tr.row_' + $i).append('<td class="block-closed" id='+ ($i * $cnt + $j) + '></td>')
            }
        }

        $('#board-size-change-button').click(function (){
            $cnt = $('#board-size-value').val()
            resize()
            setMine()
        })

        setMine()

        $('td').click(function(){
            $currId = parseInt( ($(this).attr('id')) )
            console.log('zz')
            $( '#' + $currId ).removeClass( 'block-closed' )
            setBg($currId)
            $cntMine = 0
            if( getRow($currId) == getRow($currId+1) ){ setBg($currId+1) == true ? $cntMine++ : '' }
            if( getRow($currId) == getRow($currId-1) ){ setBg($currId-1) == true ? $cntMine++ : '' }
            setBg($currId+$cnt) == true ? $cntMine++ : ''
            if( getRow($currId+$cnt) == getRow($currId+$cnt+1) ){ setBg($currId+$cnt+1) == true ? $cntMine++ : '' }
            if( getRow($currId+$cnt) == getRow($currId+$cnt-1) ){ setBg($currId+$cnt-1) == true ? $cntMine++ : '' }
            setBg($currId-$cnt) == true ? $cntMine++ : ''
            if( getRow($currId-$cnt) == getRow($currId-$cnt+1) ){ setBg($currId-$cnt+1) == true ? $cntMine++ : '' }
            if( getRow($currId-$cnt) == getRow($currId-$cnt-1) ){ setBg($currId-$cnt-1) == true ? $cntMine++ : '' }
            $(this).text($cntMine)
        })

        $('td.block-closed').on('mousedown', function (event){
            if (event.button === 2 || event.which === 3){
                $currId = parseInt( ($(this).attr('id')) )
                if ($( '#' + $currId ).hasClass( 'flag' )) $( '#' + $currId ).removeClass( 'flag' )
                else $( '#' + $currId ).addClass( 'flag' )
            }
        }).on('contextmenu', function() {
            return false;
        });

        function setBg($id){
            if( ($('#'+ $id).hasClass('css-mine')) ){
                return true;
            }
        }
        
        function getRow($id){
            return Math.floor($id/$cnt);
        }

        function setMine(){
            for($i=0; $i<$cntMine; $i++){
                //숫자가 중복될 가능성?
                $mineId = Math.floor(Math.random()*$cnt*$cnt);
                console.log($mineId);
                $('#'+ $mineId).addClass('css-mine');
            }
        }

        function resize(){
            $('#board tbody.board_row').empty()
            for($i = 0; $i < $cnt; $i++){
                $('#board tbody.board_row').append('<tr class=' + 'row_' + ($i)  +'></tr>');
                for($j = 0; $j < $cnt; $j++){
                    $('#board tr.row_' + $i).append('<td class="block-closed" id='+ ($i * $cnt + $j) + '></td>')
                }
            }
        }

    })
</script>
<input id="board-size-value" type="text">
<button id="board-size-change-button">적용</button>
<table id="board">
    <tbody class="board_row">
    </tbody>
</table>
</body>

</html>