<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minesweeper</title>
    <link href="index.css" rel="stylesheet" type="text/css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>
<script>
    //ToDo. 스크립트 별도 파일에 저장, 마우스 우클릭 이벤트 방지, 변수명 통일
    $(document).ready(function () {
        let size = 16
        let mines = 35;
        let opened = [];

        resize(size)

        $('#board-size-change-button').click(function () {
            size = $('#board-size-value').val()
            resize(size)
        })

        function setBg($id) {
            if (($('#' + $id).hasClass('css-mine'))) {
                return true;
            }
        }

        function getRow($id) {
            return Math.floor($id / size);
        }

        function openBlock($i) {
            $i = parseInt($i);
            $('#' + $i).removeClass('block-closed')

            if (($('#' + $i).text() == '0')) {
                if (opened[getRow($i)][$i % size] == 0) {

                    opened[getRow($i)][$i % size] = 1
                    console.log(opened)
                    if (getRow($i) == getRow($i + 1)) {
                        openBlock($i + 1)
                    }
                    if (getRow($i) == getRow($i - 1)) {
                        openBlock($i - 1)
                    }

                    if (getRow($i + size) == getRow($i  + size - 1)) {
                        openBlock($i + size - 1)
                    }
                    if (getRow($i + size) == getRow($i + size + 1)) {
                        openBlock($i + size + 1)
                    }
                    if (getRow($i - size) == getRow($i - size - 1)) {
                        openBlock($i - size - 1)
                    }
                    if (getRow($i - size) == getRow($i - size + 1)) {
                        openBlock($i - size + 1)
                    }

                    openBlock($i + size)

                    openBlock($i - size)
                }
            }
        }

        function resize(size) {
            $('#board tbody.board_row').empty()

            opened = []

            for ($i = 0; $i < size; $i++) {
                $('#board tbody.board_row').append('<tr class=' + 'row_' + ($i) + '></tr>');
                opened.push([])
                for ($j = 0; $j < size; $j++) {
                    $('#board tr.row_' + $i).append('<td class="block-closed" id=' + ($i * size + $j) + '></td>')
                    opened[$i].push(0)
                }
            }

            for ($i = 0; $i < mines; $i++) {
                //숫자가 중복될 가능성?
                $mineId = Math.floor(Math.random() * size * size);
                $('#' + $mineId).addClass('css-mine');
            }
            for ($i = 0; $i < size * size; $i++) {
                let mines1 = 0;
                if (getRow($i) == getRow($i + 1)) {
                    setBg($i + 1) == true ? mines1++ : ''
                }
                if (getRow($i) == getRow($i - 1)) {
                    setBg($i - 1) == true ? mines1++ : ''
                }
                setBg($i + size) == true ? mines1++ : ''
                if (getRow($i + size) == getRow($i + size + 1)) {
                    setBg($i + size + 1) == true ? mines1++ : ''
                }
                if (getRow($i + size) == getRow($i + size - 1)) {
                    setBg($i + size - 1) == true ? mines1++ : ''
                }
                setBg($i - size) == true ? mines1++ : ''
                if (getRow($i - size) == getRow($i - size + 1)) {
                    setBg($i - size + 1) == true ? mines1++ : ''
                }
                if (getRow($i - size) == getRow($i - size - 1)) {
                    setBg($i - size - 1) == true ? mines1++ : ''
                }
                $('#' + $i).text(mines1)
            }

            $('td').on("click", function () {
                $currId = parseInt(($(this).attr('id')))
                openBlock($currId)
            });

            $('td.block-closed').on('mousedown', function (event) {
                if (event.button === 2 || event.which === 3) {
                    $currId = parseInt(($(this).attr('id')))
                    if ($('#' + $currId).hasClass('flag')) $('#' + $currId).removeClass('flag')
                    else $('#' + $currId).addClass('flag')
                }
            }).on('contextmenu', function () {
                return false;
            });

        }

    })
</script>
<input id="board-size-value" type="text">
<button id="board-size-change-button">적용</button>
<table id="board">
    <tbody class="board_row">
    </tbody>
</table>
</body>

</html>